<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Conex√£o Supabase - RIDEC</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1><i class="fas fa-database"></i> Teste de Conex√£o Supabase</h1>
        <p>Este arquivo testa a conex√£o e funcionalidades do Supabase para o sistema RIDEC.</p>

        <!-- Teste de Conex√£o -->
        <div class="test-section">
            <h3>üîå Teste de Conex√£o</h3>
            <button class="test-button" onclick="testConnection()">Testar Conex√£o</button>
            <div id="connectionResult" class="test-result" style="display: none;"></div>
        </div>

        <!-- Teste de Tabelas -->
        <div class="test-section">
            <h3>üìä Teste de Tabelas</h3>
            <button class="test-button" onclick="testTables()">Verificar Tabelas</button>
            <div id="tablesResult" class="test-result" style="display: none;"></div>
        </div>

        <!-- Teste de Dados -->
        <div class="test-section">
            <h3>üìã Teste de Dados</h3>
            <button class="test-button" onclick="testData()">Verificar Dados Iniciais</button>
            <div id="dataResult" class="test-result" style="display: none;"></div>
        </div>

        <!-- Teste de Opera√ß√µes CRUD -->
        <div class="test-section">
            <h3>‚úèÔ∏è Teste de Opera√ß√µes CRUD</h3>
            <button class="test-button" onclick="testCRUD()">Testar CRUD</button>
            <div id="crudResult" class="test-result" style="display: none;"></div>
        </div>

        <!-- Informa√ß√µes do Sistema -->
        <div class="test-section">
            <h3>‚ÑπÔ∏è Informa√ß√µes do Sistema</h3>
            <div id="systemInfo" class="test-result info">
                <p><strong>URL do Supabase:</strong> <span id="supabaseUrl">-</span></p>
                <p><strong>Status da Conex√£o:</strong> <span id="connectionStatus">N√£o testado</span></p>
                <p><strong>Vers√£o do Supabase:</strong> <span id="supabaseVersion">-</span></p>
                <p><strong>Timestamp:</strong> <span id="timestamp">-</span></p>
            </div>
        </div>

        <!-- Log de Atividades -->
        <div class="test-section">
            <h3>üìù Log de Atividades</h3>
            <div id="activityLog" style="max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px;">
                <div>Log iniciado...</div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="supabase-database.js"></script>
    <script>
        // Fun√ß√£o para adicionar log
        function addLog(message, type = 'info') {
            const log = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#6c757d';
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }

        // Fun√ß√£o para mostrar resultado
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `test-result ${type}`;
            element.innerHTML = message;
        }

        // Atualizar informa√ß√µes do sistema
        function updateSystemInfo() {
            document.getElementById('supabaseUrl').textContent = SUPABASE_CONFIG.url;
            document.getElementById('timestamp').textContent = new Date().toLocaleString();
            
            if (typeof supabase !== 'undefined') {
                document.getElementById('supabaseVersion').textContent = '2.x';
            }
        }

        // Teste de conex√£o
        async function testConnection() {
            addLog('Iniciando teste de conex√£o...');
            
            try {
                if (typeof supabaseDB === 'undefined') {
                    throw new Error('supabaseDB n√£o est√° dispon√≠vel');
                }

                const connected = await supabaseDB.init();
                
                if (connected) {
                    document.getElementById('connectionStatus').textContent = 'Conectado';
                    document.getElementById('connectionStatus').style.color = '#28a745';
                    showResult('connectionResult', '‚úÖ Conex√£o estabelecida com sucesso!', 'success');
                    addLog('Conex√£o estabelecida com sucesso', 'success');
                } else {
                    throw new Error('Falha na inicializa√ß√£o');
                }
            } catch (error) {
                document.getElementById('connectionStatus').textContent = 'Erro';
                document.getElementById('connectionStatus').style.color = '#dc3545';
                showResult('connectionResult', `‚ùå Erro na conex√£o: ${error.message}`, 'error');
                addLog(`Erro na conex√£o: ${error.message}`, 'error');
            }
        }

        // Teste de tabelas
        async function testTables() {
            addLog('Verificando tabelas...');
            
            try {
                if (!supabaseDB.isConnected()) {
                    throw new Error('Supabase n√£o est√° conectado');
                }

                const tables = [
                    'empresa', 'usuario', 'tipo_usuario', 'area', 'uom',
                    'modelo_ridec', 'm_etapa_ri', 'm_etapa_d', 'm_etapa_e', 'm_etapa_c', 'm_etapa_a',
                    'etapa_ri', 'etapa_d', 'etapa_e', 'etapa_c', 'etapa_a', 'card_ridec'
                ];

                let results = [];
                for (const table of tables) {
                    try {
                        const { data, error } = await supabaseDB.getClient()
                            .from(table)
                            .select('count')
                            .limit(1);
                        
                        if (error) {
                            results.push(`‚ùå ${table}: ${error.message}`);
                        } else {
                            results.push(`‚úÖ ${table}: OK`);
                        }
                    } catch (err) {
                        results.push(`‚ùå ${table}: ${err.message}`);
                    }
                }

                showResult('tablesResult', results.join('<br>'), 'info');
                addLog('Verifica√ß√£o de tabelas conclu√≠da', 'success');
            } catch (error) {
                showResult('tablesResult', `‚ùå Erro: ${error.message}`, 'error');
                addLog(`Erro na verifica√ß√£o de tabelas: ${error.message}`, 'error');
            }
        }

        // Teste de dados
        async function testData() {
            addLog('Verificando dados iniciais...');
            
            try {
                if (!supabaseDB.isConnected()) {
                    throw new Error('Supabase n√£o est√° conectado');
                }

                const empresas = await supabaseDB.getEmpresas();
                const tiposUsuario = await supabaseDB.getTiposUsuario();
                const usuarios = await supabaseDB.getUsuarios();

                let results = [];
                results.push(`üìä Empresas: ${empresas.length}`);
                results.push(`üë• Tipos de Usu√°rio: ${tiposUsuario.length}`);
                results.push(`üë§ Usu√°rios: ${usuarios.length}`);

                if (tiposUsuario.length > 0) {
                    results.push('<br><strong>Tipos de Usu√°rio encontrados:</strong>');
                    tiposUsuario.forEach(tipo => {
                        results.push(`‚Ä¢ ${tipo.nome_tipo_usuario} (N√≠vel: ${tipo.nivel_acesso})`);
                    });
                }

                showResult('dataResult', results.join('<br>'), 'success');
                addLog('Verifica√ß√£o de dados conclu√≠da', 'success');
            } catch (error) {
                showResult('dataResult', `‚ùå Erro: ${error.message}`, 'error');
                addLog(`Erro na verifica√ß√£o de dados: ${error.message}`, 'error');
            }
        }

        // Teste de opera√ß√µes CRUD
        async function testCRUD() {
            addLog('Testando opera√ß√µes CRUD...');
            
            try {
                if (!supabaseDB.isConnected()) {
                    throw new Error('Supabase n√£o est√° conectado');
                }

                let results = [];

                // Teste de cria√ß√£o
                const novaEmpresa = {
                    nome_empresa: 'Empresa Teste CRUD',
                    ies_ativo: 'S'
                };

                const empresaCriada = await supabaseDB.createEmpresa(novaEmpresa);
                results.push(`‚úÖ Cria√ß√£o: Empresa criada com ID ${empresaCriada.cod_empresa}`);

                // Teste de leitura
                const empresas = await supabaseDB.getEmpresas();
                const empresaEncontrada = empresas.find(e => e.cod_empresa === empresaCriada.cod_empresa);
                if (empresaEncontrada) {
                    results.push(`‚úÖ Leitura: Empresa encontrada - ${empresaEncontrada.nome_empresa}`);
                }

                // Teste de atualiza√ß√£o
                const dadosAtualizacao = {
                    nome_empresa: 'Empresa Teste CRUD - Atualizada',
                    ies_ativo: 'N'
                };

                const empresaAtualizada = await supabaseDB.updateEmpresa(empresaCriada.cod_empresa, dadosAtualizacao);
                results.push(`‚úÖ Atualiza√ß√£o: Empresa atualizada - ${empresaAtualizada.nome_empresa}`);

                // Teste de exclus√£o
                await supabaseDB.deleteEmpresa(empresaCriada.cod_empresa);
                results.push(`‚úÖ Exclus√£o: Empresa removida com sucesso`);

                showResult('crudResult', results.join('<br>'), 'success');
                addLog('Teste CRUD conclu√≠do com sucesso', 'success');
            } catch (error) {
                showResult('crudResult', `‚ùå Erro: ${error.message}`, 'error');
                addLog(`Erro no teste CRUD: ${error.message}`, 'error');
            }
        }

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            updateSystemInfo();
            addLog('P√°gina de teste carregada');
        });
    </script>
</body>
</html>



