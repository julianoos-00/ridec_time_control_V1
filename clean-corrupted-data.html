<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limpeza de Dados Corrompidos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .alert {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            border-left: 4px solid #dc3545;
            background: #f8d7da;
            color: #721c24;
        }
        .btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        .btn:hover {
            background: #c82333;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        .log-error {
            background: #f8d7da;
            color: #721c24;
        }
        .log-success {
            background: #d4edda;
            color: #155724;
        }
        .log-warning {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ Limpeza de Dados Corrompidos</h1>
        
        <div class="alert">
            <strong>‚ÑπÔ∏è INFORMA√á√ÉO:</strong> Sistema de limpeza de dados atualizado!
            <br>O usu√°rio <strong>julianooschulz@gmail.com</strong> n√£o √© mais bloqueado.
            <br>Este utilit√°rio agora limpa apenas dados realmente corrompidos.
        </div>
        
        <p>Este utilit√°rio ir√° limpar completamente todos os dados corrompidos e for√ßar um novo login.</p>
        
        <div style="text-align: center;">
            <button class="btn" onclick="emergencyCleanup()">
                üö® LIMPEZA DE EMERG√äNCIA
            </button>
            <button class="btn btn-success" onclick="simulateValidLogin()">
                ‚úÖ Simular Login V√°lido
            </button>
        </div>
        
        <div class="log" id="cleanupLog">
            <div class="log-entry log-warning">Aguardando a√ß√£o...</div>
        </div>
        
        <div style="margin-top: 30px; padding: 15px; background: #e3f2fd; border-radius: 5px;">
            <h3>üìã O que ser√° limpo:</h3>
            <ul>
                <li>Dados de sess√£o (localStorage e sessionStorage)</li>
                <li>Dados do AuthChecker</li>
                <li>Dados de RIDECs</li>
                <li>Notifica√ß√µes</li>
                <li>Qualquer dado relacionado ao usu√°rio corrompido</li>
            </ul>
        </div>
    </div>

    <script>
        let logEntries = [];

        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = {
                timestamp,
                message,
                type
            };
            logEntries.push(entry);
            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logContainer = document.getElementById('cleanupLog');
            logContainer.innerHTML = logEntries.map(entry => 
                `<div class="log-entry log-${entry.type}">
                    [${entry.timestamp}] ${entry.message}
                </div>`
            ).join('');
            
            // Scroll para o final
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function emergencyCleanup() {
            addLog('üö® Iniciando limpeza de emerg√™ncia...', 'warning');
            
            try {
                // Limpar localStorage
                addLog('üßπ Limpando localStorage...', 'info');
                localStorage.removeItem('ridec_session');
                localStorage.removeItem('ridecs');
                localStorage.removeItem('notifications');
                addLog('‚úÖ localStorage limpo', 'success');
                
                // Limpar sessionStorage
                addLog('üßπ Limpando sessionStorage...', 'info');
                sessionStorage.removeItem('ridec_session');
                sessionStorage.clear();
                addLog('‚úÖ sessionStorage limpo', 'success');
                
                // Limpar AuthChecker se dispon√≠vel
                if (window.authChecker) {
                    addLog('üßπ Limpando AuthChecker...', 'info');
                    window.authChecker.currentUser = null;
                    addLog('‚úÖ AuthChecker limpo', 'success');
                }
                
                // Limpar outros dados poss√≠veis
                addLog('üßπ Limpando outros dados...', 'info');
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('ridec') || key.includes('user') || key.includes('session'))) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                    addLog(`üóëÔ∏è Removido: ${key}`, 'info');
                });
                
                addLog('‚úÖ Limpeza de emerg√™ncia conclu√≠da!', 'success');
                addLog('üîÑ Recarregando p√°gina em 3 segundos...', 'warning');
                
                // Recarregar p√°gina
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
                
            } catch (error) {
                addLog(`‚ùå Erro durante limpeza: ${error.message}`, 'error');
            }
        }

        function simulateValidLogin() {
            addLog('üîê Simulando login v√°lido...', 'info');
            
            try {
                // Limpar dados antigos primeiro
                emergencyCleanup();
                
                // Aguardar um pouco e ent√£o simular login v√°lido
                setTimeout(() => {
                    const validUser = {
                        cod_usuario: 1,
                        nome_usuario: 'Ed Schmoller',
                        email_usuario: 'edschmoller@gmail.com',
                        email: 'edschmoller@gmail.com',
                        cod_empresa: 1,
                        cod_tipo_usuario: 1,
                        ies_ativo: 'S',
                        role: 'admin'
                    };

                    const sessionData = {
                        user: validUser,
                        loginTime: new Date().toISOString(),
                        rememberMe: true
                    };

                    localStorage.setItem('ridec_session', JSON.stringify(sessionData));
                    addLog('‚úÖ Login v√°lido simulado', 'success');
                    addLog('üîÑ Redirecionando para index...', 'info');
                    
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                    
                }, 2000);
                
            } catch (error) {
                addLog(`‚ùå Erro ao simular login: ${error.message}`, 'error');
            }
        }

        // Verificar dados corrompidos ao carregar
        document.addEventListener('DOMContentLoaded', () => {
            addLog('üîç Verificando dados corrompidos...', 'info');
            
            try {
                const localData = localStorage.getItem('ridec_session');
                const sessionData = sessionStorage.getItem('ridec_session');
                
                if (localData) {
                    const parsed = JSON.parse(localData);
                    if (parsed.user) {
                        const email = parsed.user.email_usuario || parsed.user.email;
                        const name = parsed.user.nome_usuario || parsed.user.name;
                        
                        addLog(`‚úÖ Dados encontrados no localStorage: ${email}`, 'success');
                    }
                }
                
                if (sessionData) {
                    const parsed = JSON.parse(sessionData);
                    if (parsed.user) {
                        const email = parsed.user.email_usuario || parsed.user.email;
                        const name = parsed.user.nome_usuario || parsed.user.name;
                        
                        addLog(`‚úÖ Dados encontrados no sessionStorage: ${email}`, 'success');
                    }
                }
                
                if (!localData && !sessionData) {
                    addLog('‚ÑπÔ∏è Nenhum dado de sess√£o encontrado', 'info');
                }
                
            } catch (error) {
                addLog(`‚ùå Erro ao verificar dados: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>
